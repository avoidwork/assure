/*
 2013 Jason Mulligan
 @license BSD-3 <https://raw.github.com/avoidwork/assure/master/LICENSE>
 @link http://avoidwork.github.io/assure/
 @module assure
 @version 1.0.0
*/
(function(l){function c(){var a=this;this.promise=d.factory();this.onDone=[];this.onAlways=[];this.onFail=[];this.promise.then(function(b){k(function(){a.onDone.forEach(function(a){a(b)});a.onAlways.forEach(function(a){a(b)});a.onAlways=[];a.onDone=[];a.onFail=[]})},function(b){k(function(){a.onFail.forEach(function(a){a(b)});a.onAlways.forEach(function(a){a(b)});a.onAlways=[];a.onDone=[];a.onFail=[]})})}function f(){this.deferred=!1;this.handlers=[];this.state=d.state.PENDING;this.value=null}var h=
function(){return new c};h.when=function(){var a=0,b=h(),e=[].slice.call(arguments),d;e[0]instanceof Array&&(e=e[0]);d=e.length;0===d?b.resolve(null):e.forEach(function(c){c.then(function(){++a!==d||b.isResolved()||(1<e.length?b.resolve(e.map(function(a){return a.value||a.promise.value})):b.resolve(e[0].value||e[0].promise.value))},function(){b.isResolved()||(1<e.length?b.reject(e.map(function(a){return a.value||a.promise.value})):b.reject(e[0].value||e[0].promise.value))})});return b};c.prototype.constructor=
c;c.prototype.always=function(a){if("function"!==typeof a)throw Error(g.invalidArguments);if(this.promise.resolved())throw Error(g.promiseResolved.replace("{{outcome}}",this.promise.outcome));this.onAlways.push(a);return this};c.prototype.done=function(a){if("function"!==typeof a)throw Error(g.invalidArguments);if(this.promise.resolved())throw Error(g.promiseResolved.replace("{{outcome}}",this.promise.outcome));this.onDone.push(a);return this};c.prototype.fail=function(a){if("function"!==typeof a)throw Error(g.invalidArguments);
if(this.promise.resolved())throw Error(g.promiseResolved.replace("{{outcome}}",this.promise.outcome));this.onFail.push(a);return this};c.prototype.isRejected=function(){return this.promise.state===d.state.FAILURE};c.prototype.isResolved=function(){return this.promise.state===d.state.SUCCESS};c.prototype.reject=function(a){this.promise.reject.call(this.promise,a);return this};c.prototype.resolve=function(a){this.promise.resolve.call(this.promise,a);return this};c.prototype.state=function(){return this.promise.state};
c.prototype.then=function(a,b){return this.promise.then(a,b)};var k=function(){return"undefined"!==typeof setImmediate?setImmediate:"undefined"!==typeof process?process.nextTick:function(a){setTimeout(a,0)}}(),g={invalidArguments:"Invalid arguments",promiseResolved:"The promise has been resolved: {{outcome}}"},d={delay:function(){return"undefined"!==typeof setImmediate?setImmediate:"undefined"!==typeof process?process.nextTick:function(a){setTimeout(a,0)}}(),factory:function(){return new f},pipe:function(a,
b){a.then(function(a){b.resolve(a)},function(a){b.reject(a)})},state:{PENDING:0,FAILURE:1,SUCCESS:2}};f.prototype.constructor=f;f.prototype.process=function(){var a,b,e;this.deferred=!1;if(this.state!==d.state.PENDING)return e=this.value,b=this.state===d.state.SUCCESS,this.handlers.slice().forEach(function(c){var f=c[b?"success":"failure"];c=c.promise;if(f&&"function"===typeof f){try{a=f(e)}catch(g){c.reject(g);return}a&&"function"===typeof a.then?d.pipe(a,d):c.resolve(a)}else e&&"function"===typeof e.then?
d.pipe(e,c):b?c.resolve(e):c.reject(e)}),this};f.prototype.reject=function(a){var b=this;if(!(this.state>d.state.PENDING))return this.value=a,this.state=d.state.FAILURE,this.deferred||(d.delay(function(){b.process()}),this.deferred=!0),this};f.prototype.resolve=function(a){var b=this;if(!(this.state>d.state.PENDING))return this.value=a,this.state=d.state.SUCCESS,this.deferred||(d.delay(function(){b.process()}),this.deferred=!0),this};f.prototype.then=function(a,b){var c=this,g=new f;this.handlers.push({success:a,
failure:b,promise:g});this.state>d.state.PENDING&&!this.deferred&&(d.delay(function(){c.process()}),this.deferred=!0);return g};"undefined"!==typeof exports?module.exports=h:"function"===typeof define?define(function(){return h}):l.assure=h})(this);
//@ sourceMappingURL=assure.map
