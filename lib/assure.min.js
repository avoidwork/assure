/*
 2013 Jason Mulligan
 @license BSD-3 <https://raw.github.com/avoidwork/assure/master/LICENSE>
 @link http://avoidwork.github.io/assure/
 @module assure
 @version 1.0.3
*/
(function(q){function l(){return new e}function e(){var a=this;this.promise=n();this.onDone=[];this.onAlways=[];this.onFail=[];this.promise.then(function(b){m(function(){k(a.onDone,function(a){a(b)});k(a.onAlways,function(a){a(b)});a.onAlways=[];a.onDone=[];a.onFail=[]})},function(b){m(function(){k(a.onFail,function(a){a(b)});k(a.onAlways,function(a){a(b)});a.onAlways=[];a.onDone=[];a.onFail=[]})})}function k(a,b){for(var c=a.length,d=-1;++d<c&&!1!==b.call(a,a[d],d););return a}function p(a,b){a.then(function(a){b.resolve(a)},
function(a){b.reject(a)})}function n(){return new h}function h(){this.deferred=!1;this.handlers=[];this.state=g.PENDING;this.value=null}l.when=function(){var a=0,b=l(),c=[].slice.call(arguments),d;c[0]instanceof Array&&(c=c[0]);d=c.length;0===d?b.resolve(null):k(c,function(e){e.then(function(){++a!==d||b.isResolved()||(1<c.length?b.resolve(c.map(function(a){return a.value||a.promise.value})):b.resolve(c[0].value||c[0].promise.value))},function(){b.isResolved()||(1<c.length?b.reject(c.map(function(a){return a.value||
a.promise.value})):b.reject(c[0].value||c[0].promise.value))})});return b};e.prototype.constructor=e;e.prototype.always=function(a){if("function"!=typeof a)throw Error(f.invalidArguments);if(this.isResolved())throw Error(f.promiseResolved.replace("{{outcome}}",this.promise.outcome));if(this.isRejected())throw Error(f.promiseRejected.replace("{{outcome}}",this.promise.outcome));this.onAlways.push(a);return this};e.prototype.done=function(a){if("function"!=typeof a)throw Error(f.invalidArguments);if(this.isResolved())throw Error(f.promiseResolved.replace("{{outcome}}",
this.promise.outcome));if(this.isRejected())throw Error(f.promiseRejected.replace("{{outcome}}",this.promise.outcome));this.onDone.push(a);return this};e.prototype.fail=function(a){if("function"!=typeof a)throw Error(f.invalidArguments);if(this.isResolved())throw Error(f.promiseResolved.replace("{{outcome}}",this.promise.outcome));if(this.isRejected())throw Error(f.promiseRejected.replace("{{outcome}}",this.promise.outcome));this.onFail.push(a);return this};e.prototype.isRejected=function(){return this.state===
g.FAILURE};e.prototype.isResolved=function(){return this.state===g.SUCCESS};e.prototype.reject=function(a){this.promise.reject.call(this.promise,a);return this};e.prototype.resolve=function(a){this.promise.resolve.call(this.promise,a);return this};e.prototype.state=function(){return this.state};e.prototype.then=function(a,b){if("function"!=typeof a&&"function"!=typeof b)throw Error(f.invalidArguments);if(this.isResolved())throw Error(f.promiseResolved.replace("{{outcome}}",this.promise.outcome));
if(this.isRejected())throw Error(f.promiseRejected.replace("{{outcome}}",this.promise.outcome));return this.promise.then(a,b)};var m=function(){return"undefined"!=typeof setImmediate?setImmediate:"undefined"!=typeof process?process.nextTick:function(a){setTimeout(a,0)}}(),f={invalidArguments:"Invalid arguments",promiseRejected:"Rejected: {{outcome}}",promiseResolved:"Resolved: {{outcome}}"};h.prototype.constructor=h;h.prototype.process=function(){var a,b,c;this.deferred=!1;if(this.state!==g.PENDING)return c=
this.value,b=this.state===g.SUCCESS,k(this.handlers.slice(),function(d){var e=d[b?"success":"failure"];d=d.promise;if(e&&"function"==typeof e){try{a=e(c)}catch(f){d.reject(f);return}a&&"function"==typeof a.then?p(a,n):d.resolve(a)}else c&&"function"==typeof c.then?p(c,d):b?d.resolve(c):d.reject(c)}),this};h.prototype.reject=function(a){var b=this;if(!(this.state>g.PENDING))return this.value=a,this.state=g.FAILURE,this.deferred||(m(function(){b.process()}),this.deferred=!0),this};h.prototype.resolve=
function(a){var b=this;if(!(this.state>g.PENDING))return this.value=a,this.state=g.SUCCESS,this.deferred||(m(function(){b.process()}),this.deferred=!0),this};h.prototype.then=function(a,b){var c=this,d=new h;this.handlers.push({success:a,failure:b,promise:d});this.state>g.PENDING&&!this.deferred&&(m(function(){c.process()}),this.deferred=!0);return d};var g={PENDING:0,FAILURE:1,SUCCESS:2};"undefined"!=typeof exports?module.exports=l:"function"==typeof define?define(function(){return l}):q.assure=
l})(this);
//@ sourceMappingURL=assure.map
