/* 2016 Jason Mulligan <jason.mulligan@avoidwork.com> */

"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(a){function b(a,b){for(var c=a.length,d=-1;++d<c&&b.call(a,a[d],d)!==!1;);return a}function c(a,b){return a.then(function(a){b.resolve(a)},function(a){b.reject(a)})}function d(a){a.onAlways=[],a.onDone=[],a.onFail=[]}function e(a,b){return!a.isResolved()&&!a.isRejected()&&"function"==typeof b}var f=void 0,g=void 0,h=function(){return"undefined"!=typeof process?process.nextTick:"undefined"!=typeof setImmediate?setImmediate:function(a){setTimeout(a,0)}}(),i={PENDING:0,FAILURE:1,SUCCESS:2},Promise=function(){function Promise(){_classCallCheck(this,Promise),this.deferred=!1,this.handlers=[],this.state=i.PENDING,this.value=null}return _createClass(Promise,[{key:"process",value:function(){var a=void 0,d=void 0;return this.deferred=!1,this.state!==i.PENDING&&(d=this.value,a=this.state===i.SUCCESS,b(this.handlers.slice(),function(b){var e=b[a?"success":"failure"],f=b.promise,g=void 0;if(!e||"function"!=typeof e)return void(d&&"function"==typeof d.then?c(d,f):a?f.resolve(d):f.reject(d));if(e.ran)g=e.result;else try{g=e(d),e.ran=!0,e.result=g}catch(h){return e.ran=!0,e.result=h,void f.reject(h)}g&&"function"==typeof g.then?c(g,f):g instanceof Error?f.reject(g):f.resolve(g)})),this}},{key:"reject",value:function(a){var b=this;return this.state>i.PENDING?this:(this.value=a,this.state=i.FAILURE,this.deferred||(this.deferred=!0,h(function(){b.process()})),this)}},{key:"resolve",value:function(a){var b=this;return this.state>i.PENDING?this:(this.value=a,this.state=i.SUCCESS,this.deferred||(this.deferred=!0,h(function(){b.process()})),this)}},{key:"then",value:function(a,b){var c=this,d=new Promise;return this.handlers.push({success:a,failure:b,promise:d}),this.state>i.PENDING&&!this.deferred&&(this.deferred=!0,h(function(){c.process()})),d}}]),Promise}(),Deferred=function(){function Deferred(){_classCallCheck(this,Deferred),this.promise=g(),this.onDone=[],this.onAlways=[],this.onFail=[],this.bootstrap()}return _createClass(Deferred,[{key:"always",value:function(a){return e(this,a)&&this.onAlways.push(a),this}},{key:"bootstrap",value:function(){var a=this;this.promise.then(function(c){h(function(){b(["onDone","onAlways"],function(d){b(a[d],function(a){a(c)})}),d(a)})},function(c){h(function(){b(["onFail","onAlways"],function(d){b(a[d],function(a){a(c)})}),d(a)})})}},{key:"done",value:function(a){return e(this,a)&&this.onDone.push(a),this}},{key:"fail",value:function(a){return e(this,a)&&this.onFail.push(a),this}},{key:"isRejected",value:function(){return this.promise.state===i.FAILURE}},{key:"isResolved",value:function(){return this.promise.state===i.SUCCESS}},{key:"reject",value:function(a){return this.promise.reject(a),this}},{key:"resolve",value:function(a){return this.promise.resolve(a),this}},{key:"state",value:function(){return this.promise.state}},{key:"then",value:function(a,b){return this.promise.then(a,b)}}]),Deferred}();f=function(){return new Deferred},f.when=function(){for(var a=arguments.length,c=Array(a),d=0;a>d;d++)c[d]=arguments[d];var e,g=f(),h=0;return c[0]instanceof Array&&(c=c[0]),e=c.length,0===e?g.resolve(null):b(c,function(a){a.then(function(){++h!==e||g.isResolved()||(c.length>1?g.resolve(c.map(function(a){return a.value||a.promise.value})):g.resolve(c[0].value||c[0].promise.value))},function(){g.isResolved()||(c.length>1?g.reject(c.map(function(a){return a.value||a.promise.value})):g.reject(c[0].value||c[0].promise.value))})}),g},g=function(){return new Promise},"undefined"!=typeof exports?module.exports=f:"function"==typeof define?define(function(){return f}):a.assure=f}("undefined"!=typeof window?window:global);
//# sourceMappingURL=assure.min.js.map