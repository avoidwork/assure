/*
 2013 Jason Mulligan
 @license BSD-3 <https://raw.github.com/avoidwork/assure/master/LICENSE>
 @link http://avoidwork.github.io/assure/
 @module assure
 @version 0.0.3
*/
(function(r){function g(){var a=this;this.promise=b.factory();this.onDone=[];this.onAlways=[];this.onFail=[];this.promise.then(function(b){m(function(){a.onDone.forEach(function(a){a(b)});a.onAlways.forEach(function(a){a(b)});a.onAlways=[];a.onDone=[];a.onFail=[]})},function(b){m(function(){a.onFail.forEach(function(a){a(b)});a.onAlways.forEach(function(a){a(b)});a.onAlways=[];a.onDone=[];a.onFail=[]})})}function p(){this.childNodes=[];this.error=[];this.fulfill=[];this.outcome=this.parentNode=null;
this.state=b.state.pending}var q=function(){return new g};g.prototype={always:function(a){if("function"!==typeof a)throw Error(h.invalidArguments);if(this.promise.resolved())throw Error(h.promiseResolved.replace("{{outcome}}",this.promise.outcome));this.onAlways.push(a);return this},done:function(a){if("function"!==typeof a)throw Error(h.invalidArguments);if(this.promise.resolved())throw Error(h.promiseResolved.replace("{{outcome}}",this.promise.outcome));this.onDone.push(a);return this},fail:function(a){if("function"!==
typeof a)throw Error(h.invalidArguments);if(this.promise.resolved())throw Error(h.promiseResolved.replace("{{outcome}}",this.promise.outcome));this.onFail.push(a);return this},isRejected:function(){return this.promise.state===b.state.broken},isResolved:function(){return this.promise.state===b.state.resolved},reject:function(a){this.promise.reject.call(this.promise,a);return this},resolve:function(a){this.promise.resolve.call(this.promise,a);return this},state:function(){return this.promise.state},
then:function(a,b){return this.promise.then(a,b)}};g.prototype.constructor=g;var m=function(){return"undefined"!==typeof process?process.nextTick:function(a){setTimeout(a,0)}}(),h={invalidArguments:"Invalid arguments",promiseResolved:"The promise has been resolved: {{outcome}}"},b={factory:function(){return new p},freeze:"function"===typeof Object.freeze,methods:{reject:function(a){var e=this;m(function(){b.resolve.call(e,b.state.broken,a)});return this},resolve:function(a){var e=this;m(function(){b.resolve.call(e,
b.state.resolved,a)});return this},resolved:function(){return this.state===b.state.broken||this.state===b.state.resolved},then:function(a,e){var d=this,k=b.factory(),l;l=function(f){var l=f?a:e;f=f?!1:!0;var c;try{c=l.call(void 0,d.outcome),f=!1}catch(g){c=g,f=!0,void 0!==c&&!(c instanceof Error)&&("object"===typeof c&&(c=JSON.stringify(c)),c=Error(c))}finally{if(c instanceof p)d.state=b.state.pending,d.outcome=null,c.parentNode=d,c.then(function(a){d.childNodes.forEach(function(b){b.resolve(a)})},
function(a){d.childNodes.forEach(function(b){b.reject(a)})});else{if(f&&void 0===c)throw Error(h.invalidArguments);k[!f?"resolve":"reject"](c||d.outcome)}return c}};"function"===typeof a&&b.vouch.call(d,b.state.resolved,function(){return l(!0)});"function"===typeof e&&b.vouch.call(d,b.state.broken,function(){return l(!1)});k.parentNode=d;d.childNodes.push(k);return k}},resolve:function(a,e){var d=a===b.state.broken?"error":"fulfill",k=this,l=!1,f=!1,g=[],c,m,n;if(this.state!==b.state.pending){if(null!==
this.parentNode&&this.parentNode.state===b.state.resolved||0<this.childNodes.length)return;throw Error(h.promiseResolved.replace("{{outcome}}",this.outcome));}this.state=a;this.outcome=e;this[d].forEach(function(c,d){n=c.call(k,e);g.push(d);if(n instanceof p)return l=!0,k.outcome=null,k.state=b.state.pending,!1;n instanceof Error&&(f=!0,m=n,a=b.state.broken)});if(l){for(c=g.length;c--;)k[d].splice(c,1);return n}this.error=[];this.fulfill=[];f||(n=m,a=b.state.resolved);if(null!==this.parentNode&&this.parentNode.state===
b.state.pending)this.parentNode[a===b.state.resolved?"resolve":"reject"](n||this.outcome);b.freeze&&Object.freeze(this);return this},state:{broken:"rejected",pending:"pending",resolved:"fulfilled"},vouch:function(a,e){if(""===a)throw Error(h.invalidArguments);this.state===b.state.pending?this[a===b.state.resolved?"fulfill":"error"].push(e):this.state===a&&e(this.outcome);return this}};p.prototype=b.methods;p.prototype.constructor=p;"undefined"!==typeof exports?module.exports=q:"function"===typeof define?
define(function(){return q}):r.assure=q})(this);
//@ sourceMappingURL=assure.map
