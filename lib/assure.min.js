/* 2015 Jason Mulligan <jason.mulligan@avoidwork.com> */

"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(a){function b(a,b){for(var c=a.length,d=-1;++d<c&&b.call(a,a[d],d)!==!1;);return a}function c(a,b){return a.then(function(a){b.resolve(a)},function(a){b.reject(a)})}function d(a,b){return!a.isResolved()&&!a.isRejected()&&"function"==typeof b}var e=void 0,f=void 0,g=function(){return"undefined"!=typeof process?process.nextTick:"undefined"!=typeof setImmediate?setImmediate:function(a){setTimeout(a,0)}}(),h={PENDING:0,FAILURE:1,SUCCESS:2},i=function(){function a(){_classCallCheck(this,a),this.deferred=!1,this.handlers=[],this.state=h.PENDING,this.value=null}return _createClass(a,[{key:"process",value:function(){var a=void 0,d=void 0;return this.deferred=!1,this.state!==h.PENDING&&(d=this.value,a=this.state===h.SUCCESS,b(this.handlers.slice(),function(b){var e=b[a?"success":"failure"],g=b.promise,h=void 0;if(!e||"function"!=typeof e)return void(d&&"function"==typeof d.then?c(d,g):a?g.resolve(d):g.reject(d));try{h=e(d)}catch(i){return void g.reject(i)}h&&"function"==typeof h.then?c(h,f):g.resolve(h)})),this}},{key:"reject",value:function(a){var b=this;return this.state>h.PENDING?this:(this.value=a,this.state=h.FAILURE,this.deferred||(this.deferred=!0,g(function(){b.process()})),this)}},{key:"resolve",value:function(a){var b=this;return this.state>h.PENDING?this:(this.value=a,this.state=h.SUCCESS,this.deferred||(this.deferred=!0,g(function(){b.process()})),this)}},{key:"then",value:function(b,c){var d=this,e=new a;return this.handlers.push({success:b,failure:c,promise:e}),this.state>h.PENDING&&!this.deferred&&(this.deferred=!0,g(function(){d.process()})),e}}]),a}(),Deferred=function(){function Deferred(){_classCallCheck(this,Deferred),this.promise=f(),this.onDone=[],this.onAlways=[],this.onFail=[],this.bootstrap()}return _createClass(Deferred,[{key:"always",value:function(a){return d(this,a)&&this.onAlways.push(a),this}},{key:"bootstrap",value:function(){var a=this;this.promise.then(function(c){g(function(){var d=["onDone","onAlways"];b(d,function(d){b(a[d],function(a){a(c)})}),a.reset()})},function(c){g(function(){var d=["onFail","onAlways"];b(d,function(d){b(a[d],function(a){a(c)})}),a.reset()})})}},{key:"done",value:function(a){return d(this,a)&&this.onDone.push(a),this}},{key:"fail",value:function(a){return d(this,a)&&this.onFail.push(a),this}},{key:"isRejected",value:function(){return this.promise.state===h.FAILURE}},{key:"isResolved",value:function(){return this.promise.state===h.SUCCESS}},{key:"reject",value:function(a){return this.promise.reject(a),this}},{key:"resolve",value:function(a){return this.promise.resolve(a),this}},{key:"reset",value:function(){this.onAlways=[],this.onDone=[],this.onFail=[]}},{key:"state",value:function(){return this.promise.state}},{key:"then",value:function(a,b){return this.promise.then(a,b)}}]),Deferred}();e=function(){return new Deferred},e.when=function(){for(var a=arguments.length,c=Array(a),d=0;a>d;d++)c[d]=arguments[d];var f,g=e(),h=0;return c[0]instanceof Array&&(c=c[0]),f=c.length,0===f?g.resolve(null):b(c,function(a){a.then(function(){++h!==f||g.isResolved()||(c.length>1?g.resolve(c.map(function(a){return a.value||a.promise.value})):g.resolve(c[0].value||c[0].promise.value))},function(){g.isResolved()||(c.length>1?g.reject(c.map(function(a){return a.value||a.promise.value})):g.reject(c[0].value||c[0].promise.value))})}),g},f=function(){return new i},"undefined"!=typeof exports?module.exports=e:"function"==typeof define?define(function(){return e}):a.assure=e}("undefined"!=typeof window?window:global);
//# sourceMappingURL=assure.min.js.map