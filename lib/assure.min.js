/*
 2013 Jason Mulligan
 @license BSD-3 <https://raw.github.com/avoidwork/assure/master/LICENSE>
 @link http://avoidwork.github.io/assure/
 @module assure
 @version 1.0.3
*/
(function(p){function k(){return new d}function d(){var a=this;this.promise=m();this.onDone=[];this.onAlways=[];this.onFail=[];this.promise.then(function(b){l(function(){h(a.onDone,function(a){a(b)});h(a.onAlways,function(a){a(b)});a.onAlways=[];a.onDone=[];a.onFail=[]})},function(b){l(function(){h(a.onFail,function(a){a(b)});h(a.onAlways,function(a){a(b)});a.onAlways=[];a.onDone=[];a.onFail=[]})})}function h(a,b){for(var c=a.length,g=-1;++g<c&&!1!==b.call(a,a[g],g););return a}function n(a,b){a.then(function(a){b.resolve(a)},
function(a){b.reject(a)})}function m(){return new f}function f(){this.deferred=!1;this.handlers=[];this.state=e.PENDING;this.value=null}k.when=function(){var a=0,b=k(),c=[].slice.call(arguments),g;c[0]instanceof Array&&(c=c[0]);g=c.length;0===g?b.resolve(null):h(c,function(d){d.then(function(){++a!==g||b.isResolved()||(1<c.length?b.resolve(c.map(function(a){return a.value||a.promise.value})):b.resolve(c[0].value||c[0].promise.value))},function(){b.isResolved()||(1<c.length?b.reject(c.map(function(a){return a.value||
a.promise.value})):b.reject(c[0].value||c[0].promise.value))})});return b};d.prototype.constructor=d;d.prototype.always=function(a){this.isResolved()||this.isRejected()||"function"!=typeof a||this.onAlways.push(a);return this};d.prototype.done=function(a){this.isResolved()||this.isRejected()||"function"!=typeof a||this.onDone.push(a);return this};d.prototype.fail=function(a){this.isResolved()||this.isRejected()||"function"!=typeof a||this.onFail.push(a);return this};d.prototype.isRejected=function(){return this.state===
e.FAILURE};d.prototype.isResolved=function(){return this.state===e.SUCCESS};d.prototype.reject=function(a){this.promise.reject(a);return this};d.prototype.resolve=function(a){this.promise.resolve(a);return this};d.prototype.state=function(){return this.state};d.prototype.then=function(a,b){return this.promise.then(a,b)};var l=function(){return"undefined"!=typeof setImmediate?setImmediate:"undefined"!=typeof process?process.nextTick:function(a){setTimeout(a,0)}}();f.prototype.constructor=f;f.prototype.process=
function(){var a,b;this.deferred=!1;if(this.state===e.PENDING)return this;b=this.value;a=this.state===e.SUCCESS;h(this.handlers.slice(),function(c){var d=c[a?"success":"failure"];c=c.promise;var e;if(d&&"function"==typeof d){try{e=d(b)}catch(f){c.reject(f);return}e&&"function"==typeof e.then?n(e,m):c.resolve(e)}else b&&"function"==typeof b.then?n(b,c):a?c.resolve(b):c.reject(b)});return this};f.prototype.reject=function(a){var b=this;if(this.state>e.PENDING)return this;this.value=a;this.state=e.FAILURE;
this.deferred||(l(function(){b.process()}),this.deferred=!0);return this};f.prototype.resolve=function(a){var b=this;if(this.state>e.PENDING)return this;this.value=a;this.state=e.SUCCESS;this.deferred||(l(function(){b.process()}),this.deferred=!0);return this};f.prototype.then=function(a,b){var c=this,d=new f;this.handlers.push({success:a,failure:b,promise:d});this.state>e.PENDING&&!this.deferred&&(l(function(){c.process()}),this.deferred=!0);return d};var e={PENDING:0,FAILURE:1,SUCCESS:2};"undefined"!=
typeof exports?module.exports=k:"function"==typeof define?define(function(){return k}):p.assure=k})(this);
//@ sourceMappingURL=assure.map
